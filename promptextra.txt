## FEATURE X — Business Directory + Ranking System (Super Admin Controlled)

### USE

* **Central DB (Landlord)** for directory listings + ranking metadata (NOT tenant DB)
* **Filament v4** (Super Admin panel) for full CRUD + ranking controls
* **Spatie MediaLibrary** for business logos, cover images, gallery
* **Laravel Scout (optional)** for search (or fallback to DB search)

---

## GOAL

Create a **public Business Directory** where restaurants/businesses are listed and searchable. The system should:

1. **Auto-rank businesses** using an **SEO score** (computed and periodically refreshed).
2. **Randomize order slightly** so listings don’t feel “static”.
3. Allow **Super Admin** to **manually pin/boost** a business to a higher position (sponsored/paid or editorial).
4. Support **paid ranking campaigns** (e.g., featured placements for a date range) that override the algorithm.

---

## DATA MODEL (Landlord)

### DirectoryBusiness

Store the directory entry for each business/restaurant.

**Fields**

* `id`
* `tenant_id` (nullable if some listings aren’t tenants yet)
* `name`
* `slug` (unique)
* `description`
* `phone`, `email`
* `website_url`
* `address_line`, `city`, `state`, `country`
* `lat`, `lng` (optional)
* `category` / `cuisine_type` (string) + `tags` (json)
* `is_published` (bool)
* `is_verified` (bool)
* `seo_keywords` (json or text)
* `seo_score` (int default 0) — computed
* `rank_mode` enum: `AUTO | MANUAL | SPONSORED`
* `manual_rank` (int nullable) — super admin set (lower number = higher)
* `sponsored_rank` (int nullable)
* `sponsored_starts_at`, `sponsored_ends_at` (nullable)
* `random_rank_seed` (int) — periodically regenerated
* `views_count`, `clicks_count` (optional analytics)
* timestamps

**Media**

* `logo` (single)
* `cover` (single)
* `gallery` (multiple)

### DirectoryReview (optional for later)

* `business_id`, `rating`, `comment`, `customer_id` etc.

---

## FILAMENT (Super Admin)

Create a **Filament Resource**: `DirectoryBusinessResource`

### Resource requirements

**Forms**

* General info (name, slug auto, contact, description)
* Location section (address + lat/lng optional)
* Category/tags
* Publish controls (`is_published`, `is_verified`)
* SEO section (`seo_keywords`, show computed `seo_score` read-only)
* Ranking section:

  * `rank_mode` select (AUTO / MANUAL / SPONSORED)
  * `manual_rank` input (only when MANUAL)
  * Sponsored fields (only when SPONSORED): `sponsored_rank`, `starts_at`, `ends_at`
* Media uploads (MediaLibrary components)

**Table**

* Columns: logo, name, category, city, `seo_score`, `rank_mode`, `manual_rank`, `sponsored_rank`, published, verified, updated_at
* Filters: published, verified, rank_mode, category/city
* Actions:

  * View
  * Edit
  * Toggle publish
  * “Set Manual Rank” quick action (modal)
  * “Create Sponsored Campaign” quick action (modal: rank + date range)
  * “Recalculate SEO Score” action (single + bulk)
  * Bulk: publish/unpublish, verify/unverify, recalc SEO

**Permissions**

* Only **Super Admin** can manage directory + ranking settings.
* Staff/tenant users cannot modify directory ranking.

---

## PUBLIC DIRECTORY PAGES

Create public routes:

* `GET /directory` — listing page
* `GET /directory/{slug}` — business detail page

### Listing page features

* Search (name, cuisine, city, tags)
* Filters (city, cuisine/category)
* Sort options (Default = ranking algorithm, plus: Newest, Highest SEO)
* Pagination
* Show badges: Verified, Sponsored/Featured

---

## RANKING LOGIC (Algorithm + Overrides)

Implement a `DirectoryRankingService` that returns a query ordered by final rank priority.

### Ranking rules (priority order)

1. **SPONSORED active** (now between starts/ends) first

   * order by `sponsored_rank ASC`, then `seo_score DESC`
2. **MANUAL** next

   * order by `manual_rank ASC`, then `seo_score DESC`
3. **AUTO** last

   * order by a weighted score:

     * base = `seo_score`
     * add a small randomness factor using `random_rank_seed`
     * optionally add performance factor: clicks/views

Example idea (safe + simple):

* `AUTO_SCORE = seo_score + (random_rank_seed % 7)`
  Then sort by `AUTO_SCORE DESC`, tie-break by updated_at DESC.

### Randomization refresh

Create a scheduled command:

* `php artisan directory:refresh-random-seeds`
* runs daily (or every 6 hours)
* updates `random_rank_seed` for AUTO listings only

---

## SEO SCORE CALCULATION

Implement `SeoScoreService` with a transparent scoring rubric (no fake claims):

* * points if website_url exists
* * points if description length > N
* * points if keywords exist
* * points if has logo + cover
* * points if address is complete
* * points if verified
* Optional: + points if tenant has menu items (if relevant)

Add:

* Command: `directory:recalculate-seo {--business_id=}`
* Queueable job for bulk recalculation

---

## PAID RANKING (Sponsored)

Add a simple “campaign” approach using the fields on the business OR create a separate model:

### Option A (simple): fields on DirectoryBusiness

* Sponsored is active when `rank_mode=SPONSORED` and date range active.

### Option B (better): `DirectorySponsorCampaign`

* `business_id`, `rank`, `starts_at`, `ends_at`, `status`, `amount`, `payment_reference`
* Then compute “active campaign” dynamically.

**Important:** Sponsored placement must always be clearly labeled on the public directory.

---

## MULTI-TENANCY LINK

* If a DirectoryBusiness has `tenant_id`, the detail page can show a “Visit / Order” button linking to the tenant domain/subdomain.
* Keep directory itself in landlord context to avoid cross-tenant data leakage.

---

## DELIVERABLES

* Migrations + models + relationships
* MediaLibrary setup (collections + conversions for logo/cover thumbs)
* Filament Resource (Super Admin)
* Ranking + SEO services
* Commands + scheduler entries
* Public directory controllers + Blade/Livewire pages (Tailwind v4)
* Tests for ranking priority + sponsored expiry behavior

---
